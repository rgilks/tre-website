name: Refresh GitHub Cache

on:
  workflow_dispatch:  # Allows manual triggering from GitHub UI
  schedule:
    # Run automatically every 6 hours (same as the original cron)
    - cron: '0 */6 * * *'

jobs:
  refresh-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh GitHub Cache
        run: |
          echo "üîÑ Refreshing GitHub cache..."
          
          # Get the CRON_SECRET from GitHub secrets
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET not configured in GitHub secrets"
            echo "üí° Add CRON_SECRET to your repository secrets with the same value as in Cloudflare"
            exit 1
          fi
          
          # Call the cron endpoint to refresh the cache
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_SECRET" \
            "https://tre.systems/api/cron")
          
          # Extract response body and status code
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "üì° Response Status: $HTTP_STATUS"
          echo "üìÑ Response Body: $RESPONSE_BODY"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Cache refresh successful!"
          else
            echo "‚ùå Cache refresh failed with status $HTTP_STATUS"
            exit 1
          fi
          
      - name: Verify Cache Update
        run: |
          echo "üîç Verifying cache was updated..."
          
          # Wait a moment for the cache to be populated
          sleep 5
          
          # Check if the site now shows projects
          RESPONSE=$(curl -s "https://tre.systems/")
          
          if echo "$RESPONSE" | grep -q "No projects found"; then
            echo "‚ö†Ô∏è  Cache may still be empty - projects not showing"
          else
            echo "‚úÖ Cache appears to be populated - projects are showing"
          fi
